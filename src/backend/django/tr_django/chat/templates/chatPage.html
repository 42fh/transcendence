<!DOCTYPE html>
<html>
  <body>
    <center><h1>Chat {{request.user}}</h1></center>
    <br>
    {% if request.user.is_authenticated %}
    <center>Logout the chat Page <a href="{% url 'logout-user' %}">Logout</a></center>
    {% endif %}
    <div style="display: flex;">
      <div
        class="chat__item__container"
        id="id_chat_item_container"
        style="font-size: 20px; width: 70%;"
      >
        <br />
        <input type="text" id="id_message_send_input" />
        <button type="submit" id="id_message_send_button">Send Message</button>
        <br />
        <br />
      </div>

      <div
        class="user__list__container"
        id="id_user_list_container"
        style="font-size: 20px; width: 30%; border-left: 1px solid #000; padding-left: 10px;"
      >
        <h3>Connected Users:</h3>
        <ul id="id_user_list"></ul>
      </div>
    </div>

    <script>
      // Initialize with group_chat room name
      const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/group_chat/"
      );

      chatSocket.onopen = function (e) {
        console.log("The connection was set up successfully!");
      };

      chatSocket.onclose = function (e) {
        console.log("Something unexpected happened!");
      };

      document.querySelector("#id_message_send_input").focus();
      
      document.querySelector("#id_message_send_input").onkeyup = function (e) {
        if (e.keyCode == 13) {
          document.querySelector("#id_message_send_button").click();
        }
      };

      document.querySelector("#id_message_send_button").onclick = function (e) {
        var messageInput = document.querySelector("#id_message_send_input").value;
        if (messageInput.trim()) {  // Only send if message is not empty
          chatSocket.send(
            JSON.stringify({
              message: messageInput,
            })
          );
          document.querySelector("#id_message_send_input").value = "";
        }
      };

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log("Received message:", data);  // Debug log

        if (data.type === "user_list") {
          const userListContainer = document.querySelector("#id_user_list");
          userListContainer.innerHTML = "";
          data.users.forEach(function (user) {
            const li = document.createElement("li");
            li.textContent = user;
            li.style.cursor = "pointer";
            li.onclick = function() {
              createOneToOneChat(user);
            };
            userListContainer.appendChild(li);
          });
        } else if (data.type === "chat_message") {  // Changed from sendMessage to chat_message
          var div = document.createElement("div");
          div.innerHTML = data.username + " : " + data.message;
          document
            .querySelector("#id_chat_item_container")
            .appendChild(div);
        }
      };

      function createOneToOneChat(otherUser) {
        fetch('/chat/create_one_to_one_chat/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: new URLSearchParams({
            'other_user': otherUser
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.chat_room_url) {
            window.location.href = data.chat_room_url;
          } else {
            console.error('Failed to create chat room');
          }
        })
        .catch(error => console.error('Error:', error));
      }
    </script>
  </body>
</html>